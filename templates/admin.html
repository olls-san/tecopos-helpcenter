{% extends "base.html" %}

{% block title %}Gestión – Centro de Ayuda Tecopos{% endblock %}

{% block hero %}
<header class="hero-header">
    <h1>Gestión de artículos</h1>
    <p>Crear, actualizar y eliminar errores, guías, comportamientos, FAQs y novedades.</p>
</header>
{% endblock %}

{% block content %}

{# ======== ESTILOS SOLO PARA /admin ======== #}
<style>
  .section.section-admin {
    max-width: 1100px;
    margin: 40px auto 32px;
    padding: 0 24px;
  }

  .section.section-admin .admin-grid {
    display: grid;
    grid-template-columns: minmax(0, 2.1fr) minmax(0, 2fr);
    gap: 32px;
    align-items: flex-start;
  }

  @media (max-width: 900px) {
    .section.section-admin .admin-grid {
      grid-template-columns: 1fr;
    }
  }

  /* FORMULARIO IZQUIERDO */
  .section.section-admin .admin-form h2 {
    margin: 0 0 4px;
  }

  .section.section-admin .form-subtitle {
    margin: 0 0 18px;
    font-size: 0.9rem;
    color: #777777;
  }

  .section.section-admin .form-card {
    background: #ffffff;
    border-radius: 12px;
    border: 1px solid #e5e5e5;
    padding: 22px 20px 18px;
    box-shadow: 0 8px 20px rgba(0,0,0,0.04);
  }

  .section.section-admin .form-section {
    margin-bottom: 18px;
  }

  .section.section-admin .form-section + .form-section {
    padding-top: 12px;
    border-top: 1px solid #f1f1f1;
  }

  .section.section-admin .form-section h3 {
    margin-bottom: 8px;
    font-size: 0.95rem;
    font-weight: 600;
    color: #333333;
  }

  .section.section-admin .field {
    margin-bottom: 10px;
  }

  .section.section-admin .field label {
    display: block;
    font-size: 0.85rem;
    margin-bottom: 4px;
    color: #333333;
  }

  .section.section-admin .field input[type="text"],
  .section.section-admin .field input[type="file"],
  .section.section-admin .field select,
  .section.section-admin .field textarea {
    width: 100%;
    border-radius: 6px;
    border: 1px solid #d0d0d0;
    padding: 8px 10px;
    background: #ffffff;
    color: #111111;
    font-size: 0.9rem;
  }

  .section.section-admin .field-row {
    display: flex;
    gap: 12px;
  }

  .section.section-admin .field-row .field {
    flex: 1 1 0;
  }

  .section.section-admin .checkbox-inline {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    font-size: 0.85rem;
  }

  .section.section-admin .form-actions {
    margin-top: 16px;
    text-align: right;
  }

  .section.section-admin .btn-primary,
  .section.section-admin .admin-form button[type="submit"] {
    background: #ff8a00;
    border-radius: 999px;
    border: none;
    padding: 8px 20px;
    font-size: 0.9rem;
    cursor: pointer;
    color: #111111;
  }

  .section.section-admin .btn-primary:hover,
  .section.section-admin .admin-form button[type="submit"]:hover {
    background: #ffb36b;
  }

  /* LISTA DERECHA */
  .section.section-admin .admin-list {
    background: #ffffff;
    border-radius: 12px;
    border: 1px solid #e5e5e5;
    padding: 18px 16px 12px;
    box-shadow: 0 8px 20px rgba(0,0,0,0.03);
  }

  .section.section-admin .admin-list h2 {
    margin: 0 0 10px;
  }

  .section.section-admin .admin-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 0.85rem;
  }

  .section.section-admin .admin-table th,
  .section.section-admin .admin-table td {
    padding: 6px 8px;
    border-bottom: 1px solid #f0f0f0;
  }

  .section.section-admin .admin-table th {
    text-align: left;
    font-weight: 600;
    color: #333333;
  }

  .section.section-admin .btn-danger {
    background: #c0392b;
    border: none;
    color: #ffffff;
    padding: 4px 10px;
    border-radius: 4px;
    font-size: 0.8rem;
    cursor: pointer;
  }

  .section.section-admin .btn-danger:hover {
    background: #e74c3c;
  }
</style>

<section class="section section-admin">
  <div class="admin-grid">

    <!-- COLUMNA IZQUIERDA: FORMULARIO -->
    <div class="admin-form">
      <h2>Nuevo artículo</h2>
      <p class="form-subtitle">
        Crea errores, guías, comportamientos, FAQs y novedades desde un mismo formulario.
      </p>

      <form id="create-form"
            action="/admin/create"
            method="post"
            enctype="multipart/form-data">

        <div class="form-card">

          <!-- DATOS BÁSICOS -->
          <div class="form-section">
            <h3>Datos básicos</h3>

            <div class="field-row">
              <div class="field">
                <label for="type-select">Tipo de artículo</label>
                <select name="type" id="type-select" required>
                  <option value="error">Error / Incidencia</option>
                  <option value="guia">Guía</option>
                  <option value="comportamiento">Comportamiento / Buenas prácticas</option>
                  <option value="faq">FAQ</option>
                  <option value="novedad">Novedad</option>
                </select>
              </div>

              <div class="field">
                <label for="primary-category-select">Categoría principal</label>
                <select name="primary_category" id="primary-category-select" required>
                  <option value="errores">Errores</option>
                  <option value="guias">Guías</option>
                  <option value="buenas-practicas">Buenas prácticas</option>
                  <option value="faq">FAQ</option>
                  <option value="novedades">Novedades</option>
                </select>
              </div>
            </div>

            <div class="field">
              <label for="title">Título</label>
              <input type="text" name="title" id="title" required />
            </div>

            <div class="field">
              <label for="category">Categoría visible (módulo)</label>
              <input type="text" name="category" id="category" placeholder="Módulo, etiqueta..." />
            </div>
          </div>

          <!-- SOLO ERRORES -->
          <div class="form-section" data-fields="error">
            <h3>Datos de errores</h3>

            <div class="field field-inline">
              <label class="checkbox-inline">
                <input type="checkbox" name="is_common" value="true" />
                Marcar como error frecuente
              </label>
            </div>

            <div class="field">
              <label for="short_description">Descripción corta</label>
              <input type="text" name="short_description" id="short_description" />
            </div>

            <div class="field">
              <label for="client_message">Mensaje que ve el cliente</label>
              <textarea name="client_message" id="client_message" rows="2"></textarea>
            </div>

            <div class="field">
              <label for="causes">Posibles causas (una por línea)</label>
              <textarea name="causes" id="causes" rows="3"></textarea>
            </div>

            <div class="field">
              <label for="quick_steps">Pasos rápidos para el usuario (una por línea)</label>
              <textarea name="quick_steps" id="quick_steps" rows="3"></textarea>
            </div>

            <div class="field">
              <label for="internal_steps">Pasos internos / notas para soporte (una por línea)</label>
              <textarea name="internal_steps" id="internal_steps" rows="3"></textarea>
            </div>
          </div>

          <!-- DESCRIPCIÓN (GUÍA / COMPORTAMIENTO / NOVEDAD) -->
          <div id="description-container" class="form-section" style="display:none;">
            <h3>Descripción</h3>
            <div class="field">
              <label for="description">Contenido principal</label>
              <textarea name="description" id="description" rows="4"></textarea>
            </div>
          </div>

          <!-- PASO A PASO (GUÍA) -->
          <div id="steps-container" class="form-section" style="display:none;">
            <h3>Paso a paso</h3>
            <div class="field">
              <label for="steps">Pasos (una por línea)</label>
              <textarea name="steps" id="steps" rows="4"></textarea>
            </div>
          </div>

          <!-- RESPUESTA (FAQ) -->
          <div id="answer-container" class="form-section" style="display:none;">
            <h3>Respuesta (FAQ)</h3>
            <div class="field">
              <label for="answer">Respuesta al cliente</label>
              <textarea name="answer" id="answer" rows="4"></textarea>
            </div>
          </div>

          <!-- ETIQUETAS (FAQ) -->
          <div id="tags-container" class="form-section" style="display:none;">
            <h3>Etiquetas</h3>
            <div class="field">
              <label for="tags">Etiquetas (separadas por coma o línea)</label>
              <textarea name="tags" id="tags" rows="2"></textarea>
            </div>
          </div>

          <!-- ADJUNTOS -->
          <div class="form-section">
            <h3>Adjuntos</h3>
            <div class="field">
              <label>Imágenes (puedes seleccionar varias)</label>
              <input type="file" name="image_files" multiple />
            </div>
            <div class="field">
              <label>Video (opcional)</label>
              <input type="file" name="video_file" />
            </div>
          </div>

          <div class="form-actions">
            <button type="submit" class="btn-primary">Crear artículo</button>
          </div>
        </div>
      </form>

      <script>
      document.addEventListener('DOMContentLoaded', function() {
          const typeSelect = document.getElementById('type-select');
          const fieldGroups = document.querySelectorAll('[data-fields]');
          const descContainer = document.getElementById('description-container');
          const stepsContainer = document.getElementById('steps-container');
          const answerContainer = document.getElementById('answer-container');
          const tagsContainer = document.getElementById('tags-container');

          function updateVisibility() {
              const selected = typeSelect.value;
              fieldGroups.forEach(group => group.style.display = 'none');
              descContainer.style.display = 'none';
              stepsContainer.style.display = 'none';
              answerContainer.style.display = 'none';
              tagsContainer.style.display = 'none';

              if (selected === 'error') {
                  document.querySelectorAll('[data-fields="error"]').forEach(g => g.style.display = 'block');
              } else if (selected === 'guia') {
                  descContainer.style.display = 'block';
                  stepsContainer.style.display = 'block';
              } else if (selected === 'comportamiento' || selected === 'novedad') {
                  descContainer.style.display = 'block';
              } else if (selected === 'faq') {
                  answerContainer.style.display = 'block';
                  tagsContainer.style.display = 'block';
              }
          }

          updateVisibility();
          typeSelect.addEventListener('change', updateVisibility);
      });
      </script>
    </div>

    <!-- COLUMNA DERECHA: LISTA -->
    <div class="admin-list">
      <h2>Artículos existentes</h2>

      {% if errors %}
      <table class="admin-table">
        <thead>
          <tr>
            <th>ID</th>
            <th>Tipo</th>
            <th>Título</th>
            <th>Cat. principal</th>
            <th>Etiqueta</th>
            <th>Frecuente</th>
            <th></th>
          </tr>
        </thead>
        <tbody>
          {% for e in errors %}
          <tr>
            <td>{{ e.id }}</td>
            <td>{{ e.type }}</td>
            <td><a href="/errors/{{ e.id }}" target="_blank">{{ e.title }}</a></td>
            <td>{{ e.primary_category }}</td>
            <td>{{ e.category }}</td>
            <td>{% if e.is_common %}Sí{% else %}No{% endif %}</td>
            <td>
              <form action="/admin/delete/{{ e.id }}" method="post" onsubmit="return confirm('¿Eliminar este artículo?');">
                <button type="submit" class="btn-danger">Eliminar</button>
              </form>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
      {% else %}
        <p>Aún no hay artículos registrados.</p>
      {% endif %}
    </div>

  </div>
</section>
{% endblock %}
